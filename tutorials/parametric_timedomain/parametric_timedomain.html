<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,IE=9,chrome=1"><meta name="generator" content="MATLAB R2019a"><title>Fitting a custom time-domain model of a 4-pulse DEER signal</title><style type="text/css">.rtcContent { padding: 30px; } .S0 { margin: 3px 10px 5px 4px; padding: 0px; line-height: 28.7999992370605px; min-height: 0px; white-space: pre-wrap; color: rgb(213, 80, 0); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 24px; font-weight: normal; text-align: left;  }
.S1 { margin: 3px 10px 5px 4px; padding: 0px; line-height: 18px; min-height: 0px; white-space: pre-wrap; color: rgb(60, 60, 60); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 15px; font-weight: bold; text-align: left;  }
.S2 { margin: 2px 10px 9px 4px; padding: 0px; line-height: 21px; min-height: 0px; white-space: pre-wrap; color: rgb(0, 0, 0); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 14px; font-weight: normal; text-align: left;  }
.S3 { margin: 3px 10px 5px 4px; padding: 0px; line-height: 20px; min-height: 0px; white-space: pre-wrap; color: rgb(60, 60, 60); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 20px; font-weight: bold; text-align: left;  }
.CodeBlock { background-color: #F7F7F7; margin: 10px 0 10px 0;}
.S4 { border-left: 1.20000004768372px solid rgb(233, 233, 233); border-right: 1.20000004768372px solid rgb(233, 233, 233); border-top: 1.20000004768372px solid rgb(233, 233, 233); border-bottom: 0px none rgb(0, 0, 0); border-radius: 4px 4px 0px 0px; padding: 6px 45px 0px 13px; line-height: 17.2339992523193px; min-height: 18px; white-space: nowrap; color: rgb(0, 0, 0); font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px;  }
.S5 { border-left: 1.20000004768372px solid rgb(233, 233, 233); border-right: 1.20000004768372px solid rgb(233, 233, 233); border-top: 0px none rgb(0, 0, 0); border-bottom: 0px none rgb(0, 0, 0); border-radius: 0px; padding: 0px 45px 0px 13px; line-height: 17.2339992523193px; min-height: 18px; white-space: nowrap; color: rgb(0, 0, 0); font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px;  }
.S6 { border-left: 1.20000004768372px solid rgb(233, 233, 233); border-right: 1.20000004768372px solid rgb(233, 233, 233); border-top: 0px none rgb(0, 0, 0); border-bottom: 1.20000004768372px solid rgb(233, 233, 233); border-radius: 0px 0px 4px 4px; padding: 0px 45px 4px 13px; line-height: 17.2339992523193px; min-height: 18px; white-space: nowrap; color: rgb(0, 0, 0); font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 14px;  }
.S7 { margin: 10px 10px 9px 4px; padding: 0px; line-height: 21px; min-height: 0px; white-space: pre-wrap; color: rgb(0, 0, 0); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 14px; font-weight: normal; text-align: left;  }
.S8 { margin: 10px 0px 20px; padding-left: 0px; font-family: Helvetica, Arial, sans-serif; font-size: 14px;  }
.S9 { margin-left: 56px; line-height: 21px; min-height: 0px; text-align: left; white-space: pre-wrap;  }</style></head><body><div class = rtcContent><h1  class = 'S0'><span>Fitting a custom time-domain model of a 4-pulse DEER signal</span></h1><h4  class = 'S1'><span>Author: Luis Fabregas</span></h4><div  class = 'S2'><span>In this example we will construct a time-domain parametric model describing our full 4-pulse DEER signal (that means distribution + background + other time-domain parameters) using the built-in parametric models. We will then use this model to fit our full parametric model to our signal in one step.</span></div><h2  class = 'S3'><span>Generating a dipolar signal</span></h2><div  class = 'S2'><span>Let's start by simulating a dipolar signal, whose parameters we know. For this example we will use a dipolar signal with a modulation depth of 27% originating from a Gaussian distance distribution (mean distance of 3.5 </span><span texencoding="nm" style="vertical-align:-5px"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACsAAAAkCAYAAAAQC8MVAAADDklEQVRYR+3XWaivYxQG8N9BSkgKGS4MkZSMZbwgUyRTyEy4QEKGzEMouTpCOMZCZhEuyFCUIXIjx5QiZTqIMiQy9Wi9en199tk3u/zrW7X7f3u/33rf9TzrWc/734vMUCyaoVpNxS5UtyZmJ2aZBmyhVDAxOzEbBiafXSgdzDyzK2FdbIntsDNewPUlm91wJvbE8zgPHxWbK2MDbIPtsRMewu1YAXvgQuxQf7scP9W+29bavniknr/uuzTG7IZIwpHYHV/gYLyNc7ErvsLxtdE5uK6et8BmOB37VO4BeB8XF4DfsD9+qHfexDE4o844FKvjIDy5vGLb+mW4Cs/gRJxQ7CzGRsXY1jgVt3abhoAr6udRnIaT8DNuw454CR/isOpgunUR1u72nXexQXYTjkNa9THWRwoNM2nvs/ixWH+jK3Z5uadgSZFwV3UqxITpvWvft3AEPpgPs5sXwk2qwHyehe8qORK4uw4MoG+6TTfFg9XyG/A7Uky0GU1fi7Nxb4G9EstKt5fg6lqLlALgn/gvNzgQT9TL75YM3uuGqB2YjXNYCmrR2MlBr5UEPqvFdOe+moVPSlqRRKLvSD8Hcxa7YqGLhhJhLgf8OXJghui5AfjGTopNbkC3iEM8hfWK7YCOrBJ9N/fDKz2reR5jdq1qQxzhcZzctT85cYOna3KPRhhqsSbuxCG4pyb8+2696TVdOhzvdGutmy+WO3w+n2J79McWq31e9JZBiwPkOVM+xtwwd5WyuBQcq4vf/lqJfTeHa3PKoKF/HUeVE7SEXlfNsgLuFyzFXLkb44GyrqF81sAdZWUBeX/p+tOyuL/PH8qgR59JPr8KacU2Xa2DmH2KDKBr8EfH3Fhua/OrGMpnK8STV6t985n3L+07Nyw2t1dQ7YIxCUSvL9fNdDNiUxeU9TQguShyCz3WyaNv85h8GpBcFLlqV60L6dtef8Ni5zTlumFuLPN+uGzry9qwHThm6Jn+DNxeIzde0iOlOE7ilpJEfPlfMfPfuoaA/je/T8wuVCsmZidmZ+1f8b8ADNjEJeF1rdAAAAAASUVORK5CYII=" width="21.5" height="18" /></span><span> and width of 0.3 </span><span texencoding="nm" style="vertical-align:-5px"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACsAAAAkCAYAAAAQC8MVAAADDklEQVRYR+3XWaivYxQG8N9BSkgKGS4MkZSMZbwgUyRTyEy4QEKGzEMouTpCOMZCZhEuyFCUIXIjx5QiZTqIMiQy9Wi9en199tk3u/zrW7X7f3u/33rf9TzrWc/734vMUCyaoVpNxS5UtyZmJ2aZBmyhVDAxOzEbBiafXSgdzDyzK2FdbIntsDNewPUlm91wJvbE8zgPHxWbK2MDbIPtsRMewu1YAXvgQuxQf7scP9W+29bavniknr/uuzTG7IZIwpHYHV/gYLyNc7ErvsLxtdE5uK6et8BmOB37VO4BeB8XF4DfsD9+qHfexDE4o844FKvjIDy5vGLb+mW4Cs/gRJxQ7CzGRsXY1jgVt3abhoAr6udRnIaT8DNuw454CR/isOpgunUR1u72nXexQXYTjkNa9THWRwoNM2nvs/ixWH+jK3Z5uadgSZFwV3UqxITpvWvft3AEPpgPs5sXwk2qwHyehe8qORK4uw4MoG+6TTfFg9XyG/A7Uky0GU1fi7Nxb4G9EstKt5fg6lqLlALgn/gvNzgQT9TL75YM3uuGqB2YjXNYCmrR2MlBr5UEPqvFdOe+moVPSlqRRKLvSD8Hcxa7YqGLhhJhLgf8OXJghui5AfjGTopNbkC3iEM8hfWK7YCOrBJ9N/fDKz2reR5jdq1qQxzhcZzctT85cYOna3KPRhhqsSbuxCG4pyb8+2696TVdOhzvdGutmy+WO3w+n2J79McWq31e9JZBiwPkOVM+xtwwd5WyuBQcq4vf/lqJfTeHa3PKoKF/HUeVE7SEXlfNsgLuFyzFXLkb44GyrqF81sAdZWUBeX/p+tOyuL/PH8qgR59JPr8KacU2Xa2DmH2KDKBr8EfH3Fhua/OrGMpnK8STV6t985n3L+07Nyw2t1dQ7YIxCUSvL9fNdDNiUxeU9TQguShyCz3WyaNv85h8GpBcFLlqV60L6dtef8Ni5zTlumFuLPN+uGzry9qwHThm6Jn+DNxeIzde0iOlOE7ilpJEfPlfMfPfuoaA/je/T8wuVCsmZidmZ+1f8b8ADNjEJeF1rdAAAAAASUVORK5CYII=" width="21.5" height="18" /></span><span>) with a stretched exponential background model with a decay rate of 0.15</span><span texencoding="\mu s^{-1}" style="vertical-align:-5px"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAAkCAYAAAA3pUL9AAADX0lEQVRoQ+3YW8ilUxwG8N8w0Tjmwsih5EJywwVTCjNpJFKGEuUszDiGURNKTY65QAo5XjjPiHK6kxIR7nCBSDQxkbMcklOP1lurt3fvb8/sb7/T/r5v3eza7zr8n/Vfz/N/1lpkHrVF8wirBbBTmO3tsAKrsR4fd2GY9swm/kNxCU7FJpw+l8HuyP90vAtHzGWwzWldsgC2Rdxp5+xCZueqQE1lZm/AjSPW9wdwNX6v+k+VQB2MvUYE+yM+wN/TCnZEnAO7zVpmd8CuZZlf8GdryV2Qwv4Pfiq/4wa/peNnDexJeAFv4Qx8UUWSTbgXZ5eifm3HZuyJK7ASr2F3bEY28XvcvaXIOvrvVOZZNo6D2h434To8jsuQ7DbtIGws/vQsPNkKZA9EUI7CyXgXMe0X4X6swotjgg3fj8eV2B+34Tm8h7/quWcyFcnCw8Vkry3Zq8c3Wf+k9Hm/FfhheAnf4jR8VL7vgydwPd4eE+zIw2cCewiexYE4Dq9UM9dZT58LC2frxRuwe5frVzbuX4RjuYo9hE9HjnbMjjOBHcbXAHgMx5ajk1pZl4OElmP8CE7BOzgfH44Z81YPHwa2zlwyEk78Vq10QTni+WsY9/ItfI+YRejW4OutjniMgcPAJisJ8kS0+bpv+XZMEYKBF2YsRlQ6Qpd2D9a1HNAYEEYfOgxszdc8ebxepk3GryoBLx2g0u0I4o6iysly1DzH+tXRw5ydnsPAJlsbOuprgJ+D/Ypohau3FOFposqLwXeISjdteZkvXE956OL47KAaMMsgsDVfny/CEk+ampZAn8LNlUrHcFyKR/FNARLzEQFrWm1A7sM1+GOi6FqTDwJb8zUqGocUpY3biXFI+WiyHjNxZPme/2Id70BczeX4tazZWLoIVMpUVLrXNghszdcmoHAtIpOHrTiqXMniUt4or3p3FsfSZDCO6VzkZGRzciqexufbSpEHgW34+hlypH/GrcVgxIIdXTzxbgX8g5W6xgvfjpcLwAPwAw7HM+VoN9ne5pmt+XpxUdFeg5rUYl2Zbfga9TwBb05q8b7n7QLb8PVLnImv+g5qUut1gQ3A3Ei63nomFUcv87bB7lzs3HmYU3zNbrbBRjHjbPL0kvLS2/Wrj9TOdMXrI4be1phXYP8D99fBJevo0zMAAAAASUVORK5CYII=" width="29.5" height="18" /></span><span> and a dimensionality of 2.8.</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span>clc,clf,clear</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span style="color: rgb(34, 139, 34);">%Define the parameters</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>rmean = 3.5; </span><span style="color: rgb(34, 139, 34);">%nm</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>w = 0.3; </span><span style="color: rgb(34, 139, 34);">%nm</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>lam = 0.27;</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>k = 0.15; </span><span style="color: rgb(34, 139, 34);">%us-1</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre;"><span>d = 2.8;</span></span></div></div></div><div  class = 'S7'><span>We will simulate the dipolar signal on a time-axis defined between -0.2</span><span texencoding="\mu s" style="vertical-align:-5px"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACMAAAAkCAYAAAAD3IPhAAACx0lEQVRYR+3WW6hOaRwG8N9mosGQC2S4cSG54cJcKKdEalJj1ETNOIYhh5iZElNTwoxcGCkjx4txJhczuJMSEXPHDaKJJmRyGCZDcupf79Lan7X2/vaevbd98b03X613ff//83/e53neVacdrbp2hEUNTNlp1JipMdNUp9Y0U9NMTTNNZeD/aKYTPkoF/sXzimLd0Bmv8Cj9NgtfNdb+DL/jHL7EzVynAPkLpmMjVhSA7YUlGIdT6IE7iCEfYFNWrzEwHbEGK7EHixDsZGsQDmEopmFfBSU9sQ0j8Tn+QAfMw1ZMwtFqwcQUO/EFvk3T5/tlrF1L71yqADMMx3APU3Al7X+Mvfge56sFMwRHMBATcCLXLM9avDM3aSaPJwPTF1+nwV7jQ6zCDlyvFkxDeokGuzEe6/ADXhYc0y5MxgXMxuXmuCk/eRzVUvyXKzQnTRqP6p19RbPYC72F2MMI83G3CFBDAg7xRZGJBXrpl/bG4iKm4mrJxB8kl4URYm3GcjytfL8hMHm9jMHp9OdgbFkq2LvEZZV9+iRXBUvhxji2k00BE9MeLMiXADYD/ZOoQys/IoSZreG4j3BZtkaneqG1Qo2VMZPXy29JeP9gcCq0H2tzLotAXIhf8XcSc4RjCDxb+YDcgu/wLM9OGZi8XsIFkbDhlEjLCLZgIWMtwm5E2o9ncTVsQBcsxpPUMOwcKR0CjhgIl9VbZWDyesn+EGcdIoyCkcirk3jP4C/8jBfJNXFFROLORDAb4IPVA7hR5qgyMJle/kQc2WP8lAIwGo5Kd1L3BG57zh1xF63H8QRgAB7iExxOR5ex1Sgzeb0sSC4ocW3LPi5iJtNLqP9TnG3ZluXVisBkermFr3D7fYIJAHGjxtX/TVFStha4Sma6priehTbVSwxYCSYUH4kan5Zh37fXe2uxUU3otUXvd3o09tnZpqDeAMu3nCW+fRnhAAAAAElFTkSuQmCC" width="17.5" height="18" /></span><span> and 4.0</span><span texencoding="\mu s" style="vertical-align:-5px"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACMAAAAkCAYAAAAD3IPhAAACx0lEQVRYR+3WW6hOaRwG8N9mosGQC2S4cSG54cJcKKdEalJj1ETNOIYhh5iZElNTwoxcGCkjx4txJhczuJMSEXPHDaKJJmRyGCZDcupf79Lan7X2/vaevbd98b03X613ff//83/e53neVacdrbp2hEUNTNlp1JipMdNUp9Y0U9NMTTNNZeD/aKYTPkoF/sXzimLd0Bmv8Cj9NgtfNdb+DL/jHL7EzVynAPkLpmMjVhSA7YUlGIdT6IE7iCEfYFNWrzEwHbEGK7EHixDsZGsQDmEopmFfBSU9sQ0j8Tn+QAfMw1ZMwtFqwcQUO/EFvk3T5/tlrF1L71yqADMMx3APU3Al7X+Mvfge56sFMwRHMBATcCLXLM9avDM3aSaPJwPTF1+nwV7jQ6zCDlyvFkxDeokGuzEe6/ADXhYc0y5MxgXMxuXmuCk/eRzVUvyXKzQnTRqP6p19RbPYC72F2MMI83G3CFBDAg7xRZGJBXrpl/bG4iKm4mrJxB8kl4URYm3GcjytfL8hMHm9jMHp9OdgbFkq2LvEZZV9+iRXBUvhxji2k00BE9MeLMiXADYD/ZOoQys/IoSZreG4j3BZtkaneqG1Qo2VMZPXy29JeP9gcCq0H2tzLotAXIhf8XcSc4RjCDxb+YDcgu/wLM9OGZi8XsIFkbDhlEjLCLZgIWMtwm5E2o9ncTVsQBcsxpPUMOwcKR0CjhgIl9VbZWDyesn+EGcdIoyCkcirk3jP4C/8jBfJNXFFROLORDAb4IPVA7hR5qgyMJle/kQc2WP8lAIwGo5Kd1L3BG57zh1xF63H8QRgAB7iExxOR5ex1Sgzeb0sSC4ocW3LPi5iJtNLqP9TnG3ZluXVisBkermFr3D7fYIJAHGjxtX/TVFStha4Sma6priehTbVSwxYCSYUH4kan5Zh37fXe2uxUU3otUXvd3o09tnZpqDeAMu3nCW+fRnhAAAAAElFTkSuQmCC" width="17.5" height="18" /></span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span>t = linspace(-0.2,4,300);</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre;"><span>r = time2dist(t);</span></span></div></div></div><div  class = 'S7'><span>Now we can generate the signal with some added noise</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span style="color: rgb(34, 139, 34);">%Generate the distance distribution</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>P = rd_onegaussian(r,[rmean w]);</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span style="color: rgb(34, 139, 34);">%Generate the background</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>B = td_strexp(t,[k d]);</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span style="color: rgb(34, 139, 34);">%Generate the signal</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>V = dipolarsignal(t,r,P,</span><span style="color: rgb(160, 32, 240);">'moddepth'</span><span>,lam,</span><span style="color: rgb(160, 32, 240);">'background'</span><span>,B,</span><span style="color: rgb(160, 32, 240);">'noiselevel'</span><span>,0.01);</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>plot(t,V)</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre;"><span>xlabel(</span><span style="color: rgb(160, 32, 240);">'time [\mus]'</span><span>),ylabel(</span><span style="color: rgb(160, 32, 240);">'V(t)'</span><span>)</span></span></div></div></div><h2  class = 'S3'><span>Defining the time-domain model</span></h2><div  class = 'S2'><span>This is probably the most crucial step: defining the model. How well a signal can be fitted depends mainly on how well the model can describe our signal. In order to fit our time-domain dipolar signal in one step, we require a model which contains the information on the distance distribution, the background and modlation depth. Even tough such a mode is not implemented as a function in the program, we can easily define our own model using the built-in parametric models.</span></div><div  class = 'S2'><span>In this case we know the groun truth, so we will construct our time-domain model according to </span></div><div  class = 'S2'><span mathmlencoding="&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;&gt;&lt;mrow&gt;&lt;mi mathvariant=&quot;bold-italic&quot;&gt;V&lt;/mi&gt;&lt;mo&gt;=&lt;/mo&gt;&lt;mrow&gt;&lt;mo&gt;(&lt;/mo&gt;&lt;mrow&gt;&lt;mrow&gt;&lt;mo&gt;(&lt;/mo&gt;&lt;mrow&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;mo&gt;-&lt;/mo&gt;&lt;mi&gt;λ&lt;/mi&gt;&lt;mtext&gt; &lt;/mtext&gt;&lt;/mrow&gt;&lt;mo&gt;)&lt;/mo&gt;&lt;/mrow&gt;&lt;mo&gt;+&lt;/mo&gt;&lt;mtext&gt; &lt;/mtext&gt;&lt;mi&gt;λ&lt;/mi&gt;&lt;mi mathvariant=&quot;bold&quot;&gt;KP&lt;/mi&gt;&lt;/mrow&gt;&lt;mo&gt;)&lt;/mo&gt;&lt;/mrow&gt;&lt;mo&gt;⊙&lt;/mo&gt;&lt;mi mathvariant=&quot;bold-italic&quot;&gt;B&lt;/mi&gt;&lt;mtext&gt; &lt;/mtext&gt;&lt;/mrow&gt;&lt;/math&gt;" style="vertical-align:-5px"><img src="data:image/png;base64,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" width="172" height="18" /></span></div><div  class = 'S2'><span>where the background </span><span texencoding="\mathbf{B}" style="vertical-align:-5px"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABoAAAAkCAYAAACXOioTAAABzUlEQVRIS+3WT4RWURgG8N8YSkZat2m0yqymFsksaxGzqDaR0TRTi2Q2MaJNMmSiIolKi8RoRmmIZhFJ1KJFi+nfpnWUKI1IMkR5OXHcvvvN/b65vjTmcjfnz/Oc85znfc7p0qGvq0M8VonaVnrlS7cPJ7AV6xvotIA32IQP6X+CB3iPX2XaNpIu2nbiJnqzia8xhLdYi2FcyhZ0DacRi/nrKzujDbiB/dmMhziIL6mtB1dwOBsTZCfxvchURrQurfZYE6LoGsFUNuYbBvGsbqIDuFMADUln6ibai/udIIozm86IPmIP5uvcUTjvAo5noGGOMMOPuoiK9g5LT+J6I5IgbcV1UT93U20NYAve4Sxm8bVZELZC9DyBhoX7cATbE3j0XcY9LLZSsFXqKCLqPMYy4Fspwj7XdUZ/cDbjNnZkwBdxqrizVqQrRlBgr8E5jC9l8eUSBX4E6Zmliva/IYqFTqQ/39RuPMoblrujcN5VHMpA53AUn6oQVbmPAmdXyrqNCTQKeBRPq9i77IaNwIz75zG6E0lkXX8CjfbIuRdVCjbeDKH5tmZxkvoiIV6l1YdcL/GzbN7Kf25VUKy9IavStadbkxu2bcB/bu/fJKl9JePlgUUAAAAASUVORK5CYII=" width="13" height="18" /></span><span> will be modeled by a stretched exponential time-domain model (</span><span style=' font-family: monospace;'>td_strexp</span><span>) and the distribution </span><span texencoding="\mathbf{P}" style="vertical-align:-5px"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAkCAYAAACTz/ouAAABdUlEQVRIS+3WIUidURQH8J8rpoWxZlkatq0Oi8qQRa0yliYaBMGtGESYJgUxW2QqCoOB2HRFDIJNTKJlGxYVDLKwIOo4ch9cHu/tU54vqO+kj/Ode/6c//mfc2+TOltTnfNrABQy/PAo6sYI3hTWzjaOsIl17OOy/FwlisLXg3k8zQ5s4CN+4ln6HstiFjCKwxykWg9asISOLHgWw/ibfM2YwlAWs4oBHJd81QCeJ4B3/wGIX134UUbLZ8zgKvy1ArzCd7zMQBYxiD93AdCKb3idAUTD3+O0XgBRUR/O7gIg5Bw9yNU2gS+4qBUg+heqms7o2UUv9mpVUSTvxBxepGS/8QkrJQXdtoItrCXlteNtShxqCd7H8esmkxwxleagBHCe+A0aTnBQamil9VLrHBSurAbAI6YohmcZbdW2ZCE3KaCSip7gA76WJQnd9yPm4XrX38TKAeJOnkSs4Wq2k5ZZ3F6F9vCeLYUl3zagQVEhY/efon8CqGclCfN3YAAAAABJRU5ErkJggg==" width="12" height="18" /></span><span> will be modeled by a single Gaussian distribution (</span><span style=' font-family: monospace;'>rd_onegaussian</span><span>)</span></div><div  class = 'S2'><span>We can build the model by defining an anonymous function handle </span><span style=' font-family: monospace;'>model</span><span>, which must first accept the time axis </span><span style=' font-family: monospace;'>t</span><span> and the parameters </span><span style=' font-family: monospace;'>par</span><span>. The parameters of our model must be defined on a vector </span><span style=' font-family: monospace;'>par</span></div><ul  class = 'S8'><li  class = 'S9'><span style=' font-family: monospace;'>par(1) -&gt; lam</span></li><li  class = 'S9'><span style=' font-family: monospace;'>par(2) -&gt; rmean</span></li><li  class = 'S9'><span style=' font-family: monospace;'>par(3) -&gt; w</span></li><li  class = 'S9'><span style=' font-family: monospace;'>par(4) -&gt; k</span></li><li  class = 'S9'><span style=' font-family: monospace;'>par(5) -&gt; d</span></li></ul><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span style="color: rgb(34, 139, 34);">%Define our time-domain model</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre;"><span>model = @(t,par) (1 - par(1) + par(1)*dipolarkernel(t,r)*rd_onegaussian(r,par(2:3))).*td_strexp(t,par(4:5));</span></span></div></div></div><h2  class = 'S3'><span>Fitting the model</span></h2><div  class = 'S2'><span>At this point our model is ready to be fitted. The only remaining step remaining is to define the initial values of the model parameters. Since it is a custom model, all parameter values will be unbounded so it is recommended to set some upper/lower boundaries for them. All three values can be defined as vectors with the same order as in the </span><span style=' font-family: monospace;'>par</span><span> vector. All these values can be well-estimated by visual inspection of the data.</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span style="color: rgb(34, 139, 34);">% Parameter lam rmean  w   k   d</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span style="color: rgb(34, 139, 34);">% Index      1    2    3   4   5</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>par0 =     [0.35 4.0 0.4  0.1 3.0];</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>lower =    [0.10 2.0 0.1  0.0 2.0];</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre;"><span>upper =    [0.50 7.0 0.5  0.3 4.0];</span></span></div></div></div><div  class = 'S7'><span>Finally we can launch the fitting function to obtain our fitted model parameters.</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span style="color: rgb(34, 139, 34);">%Launch the fit</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre;"><span>fitpar = fitparamodel(V,model,t,par0,</span><span style="color: rgb(160, 32, 240);">'lower'</span><span>,lower,</span><span style="color: rgb(160, 32, 240);">'upper'</span><span>,upper);</span></span></div></div></div><div  class = 'S7'><span>We can now obtain the fitted models, and compare the fit parameters to our input parameters:</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre;"><span style="color: rgb(34, 139, 34);">%Get the fits</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>Vfit = model(t,fitpar);</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>Pfit = rd_onegaussian(r,fitpar(2:3));</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span style="color: rgb(34, 139, 34);">%Plot results</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>subplot(121)</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>plot(t,V,</span><span style="color: rgb(160, 32, 240);">'k.'</span><span>,t,Vfit)</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>subplot(122)</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>plot(r,P,</span><span style="color: rgb(160, 32, 240);">'k'</span><span>,r,Pfit)</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre;"><span>round(par,2)</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre;"><span>round(fitpar,2)</span></span></div></div></div></div>
<br>
<!-- 
##### SOURCE BEGIN #####
%% Fitting a custom time-domain model of a 4-pulse DEER signal
% Author: Luis Fabregas
% In this example we will construct a time-domain parametric model describing 
% our full 4-pulse DEER signal (that means distribution + background + other time-domain 
% parameters) using the built-in parametric models. We will then use this model 
% to fit our full parametric model to our signal in one step.
%% Generating a dipolar signal
% Let's start by simulating a dipolar signal, whose parameters we know. For 
% this example we will use a dipolar signal with a modulation depth of 27% originating 
% from a Gaussian distance distribution (mean distance of 3.5 $nm$ and width of 
% 0.3 $nm$) with a stretched exponential background model with a decay rate of 
% 0.15$\mu s^{-1}$ and a dimensionality of 2.8.

clc,clf,clear

%Define the parameters
rmean = 3.5; %nm
w = 0.3; %nm
lam = 0.27;
k = 0.15; %us-1
d = 2.8;
%% 
% We will simulate the dipolar signal on a time-axis defined between -0.2$\mu 
% s$ and 4.0$\mu s$

t = linspace(-0.2,4,300);
r = time2dist(t);
%% 
% Now we can generate the signal with some added noise

%Generate the distance distribution
P = rd_onegaussian(r,[rmean w]);
%Generate the background
B = td_strexp(t,[k d]);
%Generate the signal
V = dipolarsignal(t,r,P,'moddepth',lam,'background',B,'noiselevel',0.01);

plot(t,V)
xlabel('time [\mus]'),ylabel('V(t)')
%% Defining the time-domain model
% This is probably the most crucial step: defining the model. How well a signal 
% can be fitted depends mainly on how well the model can describe our signal. 
% In order to fit our time-domain dipolar signal in one step, we require a model 
% which contains the information on the distance distribution, the background 
% and modlation depth. Even tough such a mode is not implemented as a function 
% in the program, we can easily define our own model using the built-in parametric 
% models.
% 
% In this case we know the groun truth, so we will construct our time-domain 
% model according to 
% 
% $$\mathit{\mathbf{V}}=\left(\left(1-\lambda \;\right)+\;\lambda \mathbf{KP}\right)\odot 
% \mathit{\mathbf{B}}\;$$
% 
% where the background $\mathbf{B}$ will be modeled by a stretched exponential 
% time-domain model (|td_strexp|) and the distribution $\mathbf{P}$ will be modeled 
% by a single Gaussian distribution (|rd_onegaussian|)
% 
% We can build the model by defining an anonymous function handle |model|, which 
% must first accept the time axis |t| and the parameters |par|. The parameters 
% of our model must be defined on a vector |par|
%% 
% * |par(1) -> lam|
% * |par(2) -> rmean|
% * |par(3) -> w|
% * |par(4) -> k|
% * |par(5) -> d|

%Define our time-domain model
model = @(t,par) (1 - par(1) + par(1)*dipolarkernel(t,r)*rd_onegaussian(r,par(2:3))).*td_strexp(t,par(4:5));
%% Fitting the model
% At this point our model is ready to be fitted. The only remaining step remaining 
% is to define the initial values of the model parameters. Since it is a custom 
% model, all parameter values will be unbounded so it is recommended to set some 
% upper/lower boundaries for them. All three values can be defined as vectors 
% with the same order as in the |par| vector. All these values can be well-estimated 
% by visual inspection of the data.

% Parameter lam rmean  w   k   d
% Index      1    2    3   4   5
par0 =     [0.35 4.0 0.4  0.1 3.0];
lower =    [0.10 2.0 0.1  0.0 2.0];
upper =    [0.50 7.0 0.5  0.3 4.0];
%% 
% Finally we can launch the fitting function to obtain our fitted model parameters.

%Launch the fit
fitpar = fitparamodel(V,model,t,par0,'lower',lower,'upper',upper);
%% 
% We can now obtain the fitted models, and compare the fit parameters to our 
% input parameters:

%Get the fits
Vfit = model(t,fitpar);
Pfit = rd_onegaussian(r,fitpar(2:3));

%Plot results
subplot(121)
plot(t,V,'k.',t,Vfit)
subplot(122)
plot(r,P,'k',r,Pfit)

round(par,2)
round(fitpar,2)
##### SOURCE END #####
--></body></html>