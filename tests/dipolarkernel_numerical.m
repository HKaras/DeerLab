function [err,data,maxerr] = test(opt,olddata)

%======================================================
% Check kernel is constructed properly
%======================================================

oldKdiag = [1.0000 0.4691 -0.1149 -0.2204 -0.1619 0.0299 0.2040 0.1691 0.0128 -0.1039 -0.1436 -0.1289 -0.0706 0.0178 0.1027 0.1490 0.1440 0.0998 0.0390 -0.0190 ...
 -0.0642 -0.0941 -0.1106 -0.1162 -0.1134 -0.1040 -0.0893 -0.0707 -0.0494 -0.0268 -0.0042 0.0174 0.0373 0.0550 0.0702 0.0830 0.0934 0.1018 0.1082 0.1131 ...
 0.1168 0.1194 0.1212 0.1224 0.1232 0.1237 0.1240 0.1241 0.1242 0.1242 0.1242 0.1242 0.1241 0.1240 0.1238 0.1235 0.1230 0.1223 0.1214 0.1201 ...
 0.1186 0.1166 0.1143 0.1114 0.1081 0.1043 0.0999 0.0950 0.0896 0.0836 0.0770 0.0700 0.0624 0.0545 0.0461 0.0375 0.0285 0.0194 0.0101 0.0007 ...
 -0.0086 -0.0179 -0.0270 -0.0359 -0.0446 -0.0529 -0.0608 -0.0683 -0.0753 -0.0818 -0.0878 -0.0933 -0.0982 -0.1025 -0.1062 -0.1094 -0.1119 -0.1139 -0.1153 -0.1161 ...
 -0.1163 -0.1159 -0.1149 -0.1132 -0.1110 -0.1082 -0.1047 -0.1006 -0.0958 -0.0905 -0.0845 -0.0778 -0.0706 -0.0628 -0.0544 -0.0454 -0.0360 -0.0261 -0.0159 -0.0053 ...
 0.0056 0.0166 0.0278 0.0389 0.0500 0.0610 0.0717 0.0820 0.0920 0.1014 0.1102 0.1184 0.1258 0.1324 0.1382 0.1430 0.1469 0.1499 0.1518 0.1528 ...
 0.1528 0.1518 0.1498 0.1469 0.1431 0.1384 0.1330 0.1268 0.1199 0.1124 0.1044 0.0959 0.0869 0.0776 0.0681 0.0583 0.0483 0.0383 0.0283 0.0183 ...
 0.0084 -0.0013 -0.0109 -0.0203 -0.0294 -0.0382 -0.0467 -0.0549 -0.0627 -0.0702 -0.0773 -0.0840 -0.0903 -0.0963 -0.1018 -0.1070 -0.1118 -0.1162 -0.1203 -0.1240 ...
 -0.1274 -0.1304 -0.1331 -0.1355 -0.1376 -0.1394 -0.1409 -0.1422 -0.1431 -0.1438 -0.1442 -0.1444 -0.1443 -0.1439 -0.1434 -0.1425 -0.1414 -0.1401 -0.1385 -0.1367 ...
 -0.1346 -0.1323 -0.1297 -0.1269 -0.1238 -0.1205 -0.1169 -0.1131 -0.1090 -0.1047 -0.1001 -0.0953 -0.0903 -0.0850 -0.0796 -0.0738 -0.0679 -0.0618 -0.0555 -0.0490 ...
 -0.0423 -0.0355 -0.0285 -0.0214 -0.0142 -0.0068 0.0006 0.0082 0.0158 0.0234 0.0311 0.0388 0.0465 0.0543 0.0619 0.0696 0.0771 0.0846 0.0920 0.0993 ...
 0.1065 0.1136 0.1205 0.1272 0.1338 0.1401 0.1463 0.1523 0.1580 0.1635 0.1688 0.1738 0.1786 0.1831 0.1873 0.1913 0.1950 0.1984 0.2015 0.2043 ...
 0.2069 0.2091 0.2111 0.2127 0.2141 0.2152 0.2160 0.2165 0.2167 0.2166 0.2163 0.2157 0.2148 0.2137 0.2123 0.2107 0.2088 0.2067 0.2043 0.2018 ...
 0.1990 0.1960 0.1928 0.1894 0.1859 0.1822 0.1783 0.1742 0.1700 0.1656 0.1612 0.1565 0.1518 0.1470 0.1420 0.1370 0.1319 0.1267 0.1214 0.1161 ...
 0.1107 0.1053 0.0998 0.0943 0.0887 0.0832 0.0776 0.0720 0.0664 0.0608 0.0553 0.0497 0.0441 0.0386 0.0331 0.0276 0.0222 0.0168 0.0114 0.0061 ...
 0.0008 -0.0044 -0.0095 -0.0146 -0.0197 -0.0246 -0.0295 -0.0344 -0.0392 -0.0439 -0.0485 -0.0531 -0.0576 -0.0620 -0.0663 -0.0706 -0.0747 -0.0788 -0.0829 -0.0868 ...
 -0.0907 -0.0945 -0.0982 -0.1018 -0.1054 -0.1089 -0.1123 -0.1156 -0.1188 -0.1220 -0.1251 -0.1281 -0.1311 -0.1339 -0.1368 -0.1395 -0.1422 -0.1447 -0.1473 -0.1497 ...
 -0.1521 -0.1545 -0.1567 -0.1589 -0.1611 -0.1632 -0.1652 -0.1672 -0.1691 -0.1709 -0.1728 -0.1745 -0.1762 -0.1779 -0.1795 -0.1810 -0.1825 -0.1840 -0.1854 -0.1868 ...
 -0.1881 -0.1894 -0.1907 -0.1919 -0.1931 -0.1942 -0.1953 -0.1964 -0.1974 -0.1984 -0.1994 -0.2003 -0.2012 -0.2021 -0.2030 -0.2038 -0.2046 -0.2054 -0.2061 -0.2068 ...
 -0.2075 -0.2082 -0.2088 -0.2095 -0.2101 -0.2106 -0.2112 -0.2118 -0.2123 -0.2128 -0.2133 -0.2137 -0.2142 -0.2146 -0.2150 -0.2154 -0.2158 -0.2161 -0.2165 -0.2168 ...
 -0.2171 -0.2174 -0.2177 -0.2180 -0.2182 -0.2185 -0.2187 -0.2189 -0.2191 -0.2193 -0.2195 -0.2196 -0.2198 -0.2199 -0.2200 -0.2201 -0.2202 -0.2203 -0.2204 -0.2204 ...
 -0.2204 -0.2205 -0.2205 -0.2205 -0.2205 -0.2204 -0.2204 -0.2203 -0.2203 -0.2202 -0.2201 -0.2200 -0.2199 -0.2197 -0.2196 -0.2194 -0.2193 -0.2191 -0.2189 -0.2186 ...
 -0.2184 -0.2182 -0.2179 -0.2176 -0.2174 -0.2171 -0.2167 -0.2164 -0.2161 -0.2157 -0.2153 -0.2150 -0.2146 -0.2141 -0.2137 -0.2133 -0.2128 -0.2123 -0.2118 -0.2113 ...
 -0.2108 -0.2103 -0.2097 -0.2092 -0.2086 -0.2080 -0.2074 -0.2067 -0.2061 -0.2054 -0.2048 -0.2041 -0.2034 -0.2026 -0.2019 -0.2011 -0.2004 -0.1996 -0.1988 -0.1980];


N = 500;
dt = 0.008;
t = linspace(0,dt*N,N);
DistAxis = time2dist(t);
K = dipolarkernel(t,DistAxis);
K = K/mean(diff(DistAxis));
newKdiag = diag(K).';

err = any(abs(newKdiag - oldKdiag)>8e-3);
maxerr = max(abs(newKdiag - oldKdiag));
data = [];

end