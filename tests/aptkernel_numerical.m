function [pass,maxerr] = test(opt)

% Check that aptkernel() is constructed as was in DeerAnalysis

%Control vectors extracted from the APT kernel of DeerAnalysis
tnorm_old =  [97.7108 47.3550 31.1710 23.0929 18.3430 15.1978 12.9709 11.3131 10.0272 9.0068 8.1710 7.4806 6.8943 6.3965 5.9626 5.5868 5.2528 4.9591 4.6941 4.4583 ...
 4.2429 4.0495 3.8710 3.7094 3.5591 3.4221 3.2938 3.1762 3.0653 2.9633 2.8666 2.7772 2.6921 2.6132 2.5377 2.4675 2.4001 2.3372 2.2766 2.2201 ...
 2.1653 2.1141 2.0644 2.0178 1.9725 1.9300 1.8885 1.8495 1.8114 1.7754 1.7403 1.7071 1.6746 1.6439 1.6137 1.5852 1.5571 1.5306 1.5044 1.4796 ...
 1.4551 1.4319 1.4089 1.3872 1.3656 1.3452 1.3249 1.3057 1.2866 1.2685 1.2504 1.2333 1.2163 1.2000 1.1839 1.1685 1.1532 1.1387 1.1241 1.1103 ...
 1.0964 1.0833 1.0701 1.0576 1.0450 1.0330 1.0211 1.0096 0.9982 0.9873 0.9763 0.9659 0.9554 0.9454 0.9354 0.9258 0.9162 0.9070 0.8977 0.8889 ...
 0.8800 0.8716 0.8630 0.8549 0.8467 0.8388 0.8309 0.8234 0.8157 0.8085 0.8011 0.7941 0.7870 0.7802 0.7734 0.7669 0.7602 0.7539 0.7475 0.7414 ...
 0.7352 0.7293 0.7234 0.7176 0.7118 0.7063 0.7007 0.6953 0.6899 0.6847 0.6794 0.6744 0.6693 0.6644 0.6594 0.6547 0.6499 0.6453 0.6406 0.6361 ...
 0.6315 0.6272 0.6228 0.6185 0.6142 0.6101 0.6059 0.6019 0.5978 0.5940 0.5900 0.5862 0.5823 0.5786 0.5749 0.5713 0.5676 0.5641 0.5605 0.5571 ...
 0.5536 0.5502 0.5468 0.5436 0.5403 0.5371 0.5338 0.5307 0.5276 0.5245 0.5214 0.5185 0.5155 0.5126 0.5096 0.5068 0.5039 0.5011 0.4983 0.4956 ...
 0.4928 0.4902 0.4875 0.4849 0.4823 0.4797 0.4771 0.4747 0.4721 0.4697 0.4672 0.4649 0.4624 0.4601 0.4577 0.4554 0.4531 0.4509 0.4486 0.4464 ...
 0.4442 0.4420 0.4398 0.4377 0.4356 0.4335 0.4314 0.4294 0.4273 0.4253 0.4233 0.4213 0.4193 0.4174 0.4155 0.4136 0.4117 0.4098 0.4079 0.4061 ...
 0.4043 0.4025 0.4007 0.3989 0.3971 0.3954 0.3937 0.3920 0.3902 0.3886 0.3869 0.3853 0.3836 0.3820 0.3804 0.3788 0.3772 0.3756 0.3740 0.3725 ...
 0.3710 0.3695 0.3679 0.3665 0.3649 0.3635 0.3620 0.3606 0.3591 0.3577 0.3562 0.3549 0.3534 0.35200];

basediag_old =  [1.0000 0.9999 0.9994 0.9975 0.9933 0.9853 0.9717 0.9505 0.9196 0.8771 0.8212 0.7509 0.6660 0.5676 0.4583 0.3423 0.2249 0.1125 0.0115 -0.0730 ...
 -0.1376 -0.1817 -0.2074 -0.2188 -0.2199 -0.2130 -0.1970 -0.1679 -0.1205 -0.0526 0.0312 0.1171 0.1853 0.2161 0.1992 0.1390 0.0544 -0.0301 -0.0951 -0.1328 ...
 -0.1444 -0.1318 -0.0928 -0.0261 0.0569 0.1275 0.1527 0.1186 0.0426 -0.0386 -0.0949 -0.1161 -0.1022 -0.0524 0.0255 0.0992 0.1236 0.0808 0.0006 -0.0687 ...
 -0.0994 -0.0863 -0.0304 0.0498 0.1041 0.0873 0.0137 -0.0588 -0.0893 -0.0686 -0.0021 0.0735 0.0925 0.0352 -0.0425 -0.0808 -0.0619 0.0069 0.0765 0.0747 ...
 0.0031 -0.0624 -0.0715 -0.0192 0.0576 0.0760 0.0119 -0.0566 -0.0661 -0.0101 0.0629 0.0619 -0.0120 -0.0644 -0.0457 0.0284 0.0706 0.0181 -0.0514 -0.0550 ...
 0.0109 0.0666 0.0253 -0.0466 -0.0525 0.0141 0.0639 0.0134 -0.0519 -0.0400 0.0342 0.0550 -0.0153 -0.0556 -0.0086 0.0564 0.0213 -0.0469 -0.0345 0.0395 ...
 0.0416 -0.0323 -0.0446 0.0246 0.0484 -0.0227 -0.0465 0.0187 0.0482 -0.0217 -0.0443 0.0226 0.0431 -0.0287 -0.0374 0.0340 0.0303 -0.0396 -0.0213 0.0460 ...
 0.0058 -0.0451 0.0074 0.0435 -0.0254 -0.0317 0.0387 0.0128 -0.0430 0.0076 0.0396 -0.0300 -0.0216 0.0430 -0.0065 -0.0371 0.0305 0.0154 -0.0404 0.0138 ...
 0.0298 -0.0368 -0.0001 0.0367 -0.0312 -0.0090 0.0390 -0.0269 -0.0132 0.0390 -0.0252 -0.0132 0.0381 -0.0265 -0.0093 0.0359 -0.0301 -0.0014 0.0307 -0.0340 ...
 0.0104 0.0203 -0.0352 0.0243 0.0040 -0.0295 0.0346 -0.0158 -0.0134 0.0329 -0.0310 0.0113 0.0137 -0.0311 0.0320 -0.0151 -0.0098 0.0283 -0.0323 0.0224 ...
 -0.0028 -0.0188 0.0315 -0.0301 0.0181 -0.0002 -0.0188 0.0303 -0.0303 0.0220 -0.0073 -0.0106 0.0237 -0.0298 0.0296 -0.0210 0.0076 0.0056 -0.0187 0.0273 ...
 -0.0294 0.0279 -0.0206 0.0102 0.0000 -0.0116 0.0199 -0.0256 0.0292 -0.0278 0.0253 -0.0198 0.0128 -0.0062 -0.0022 0.0082 -0.0148 0.0194 -0.0229 0.0259 ...
 -0.0265 0.0278 -0.0265 0.0263 -0.0242 0.0229 -0.0207 0.0189 -0.0171 0.0152 -0.0140 0.0123 -0.0118 0.0105];

%Simulate the same kernel with DeerLab
N = 512;
dt = 0.008;
t = linspace(0,dt*(N-1),N);
K = aptkernel(t);
nu = K.FreqAxis;
Base = K.Base;
Base = Base/mean(abs(diff(nu)));
NormFactor = K.NormalizationFactor;
NormFactor = NormFactor/(mean(abs(diff(nu))))^2;
t = K.t;
tnorm_new = NormFactor.';
basediag_new = diag(Base).';

% Pass 1: All kernel base diagonal elements are similar to DeerAnalysis
pass(1) = all(abs(basediag_new - basediag_old) < 1e-3);
% Pass 1: All kernel normalization factors are similar to DeerAnalysis
pass(2) = all(abs(tnorm_new - tnorm_old) < 1e-1);

pass = all(pass);

maxerr = max(abs(basediag_new - basediag_old));
 

end