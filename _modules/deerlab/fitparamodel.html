

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>deerlab.fitparamodel &mdash; DeerLab  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="/source/_static/custom.css" type="text/css" />
  <link rel="stylesheet" href="/source/_static/theme_override.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/table_util.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/table_main.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_override.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery-dataframe.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                v0.13.0-dev
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../basics.html">Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../beginners_guide.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../uncertainty.html">Uncertainty</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../functions.html">Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modelsref.html">Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../theory.html">Theory</a></li>
</ul>
<p class="caption"><span class="caption-text">Others</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../funding.html">Funding</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Release Notes</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">DeerLab</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>deerlab.fitparamodel</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for deerlab.fitparamodel</h1><div class="highlight"><pre>
<span></span><span class="c1"># fitparamodel.py - Parametric dipolar signal model fit function</span>
<span class="c1"># ---------------------------------------------------------------</span>
<span class="c1"># This file is a part of DeerLab. License is MIT (see LICENSE.md).</span>
<span class="c1"># Copyright(c) 2019-2020: Luis Fabregas, Stefan Stoll and other contributors.</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">deerlab.utils</span> <span class="kn">import</span> <span class="n">isempty</span><span class="p">,</span> <span class="n">multistarts</span><span class="p">,</span> <span class="n">hccm</span><span class="p">,</span> <span class="n">parse_multidatasets</span><span class="p">,</span> <span class="n">goodness_of_fit</span><span class="p">,</span> <span class="n">Jacobian</span>
<span class="kn">from</span> <span class="nn">deerlab.classes</span> <span class="kn">import</span> <span class="n">UncertQuant</span><span class="p">,</span> <span class="n">FitResult</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">least_squares</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<div class="viewcode-block" id="fitparamodel"><a class="viewcode-back" href="../../functions/fitparamodel.html#deerlab.fitparamodel">[docs]</a><span class="k">def</span> <span class="nf">fitparamodel</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">par0</span><span class="o">=</span><span class="p">[],</span><span class="n">lb</span><span class="o">=</span><span class="p">[],</span><span class="n">ub</span><span class="o">=</span><span class="p">[],</span> <span class="n">weights</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                 <span class="n">multistart</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">maxeval</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">maxiter</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">,</span>
                 <span class="n">rescale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">uqanalysis</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">covmatrix</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot; Fits the dipolar signal(s) to a parametric model using non-linear least-squares.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    V : array_like or list of array_like</span>
<span class="sd">        Dipolar signal(s) to be fitted.</span>
<span class="sd">    Vmodel : callable</span>
<span class="sd">        Function taking an array of parameters and returning the dipolar signal(s) as an array or a list of arrays.</span>
<span class="sd">    par0  : array_like</span>
<span class="sd">        Start values of the model parameters.</span>
<span class="sd">    lb : array_like      </span>
<span class="sd">        Lower bounds for the model parameters. If not specified, it is left unbounded.</span>
<span class="sd">    ub : array_like     </span>
<span class="sd">        Upper bounds for the model parameters. If not specified, it is left unbounded.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :ref:`FitResult` with the following fields defined:</span>
<span class="sd">    param : ndarray</span>
<span class="sd">        Fitted model parameters</span>
<span class="sd">    uncertainty : :ref:`UncertQuant`</span>
<span class="sd">        Covariance-based uncertainty quantification of the fitted parameters.</span>
<span class="sd">    scale : float int or list of float int</span>
<span class="sd">        Amplitude scale(s) of the dipolar signal(s).</span>
<span class="sd">    plot : callable</span>
<span class="sd">        Function to display the results. It will </span>
<span class="sd">        display the fitted signals. If requested, the function returns </span>
<span class="sd">        the `matplotlib.axes` object as output. </span>
<span class="sd">    stats :  dict</span>
<span class="sd">        Goodness of fit statistical estimators:</span>

<span class="sd">        * ``stats[&#39;chi2red&#39;]`` - Reduced \chi^2 test</span>
<span class="sd">        * ``stats[&#39;r2&#39;]`` - R^2 test</span>
<span class="sd">        * ``stats[&#39;rmsd&#39;]`` - Root-mean squared deviation (RMSD)</span>
<span class="sd">        * ``stats[&#39;aic&#39;]`` - Akaike information criterion</span>
<span class="sd">        * ``stats[&#39;aicc&#39;]`` - Corrected Akaike information criterion</span>
<span class="sd">        * ``stats[&#39;bic&#39;]`` - Bayesian information criterion</span>
<span class="sd">    success : bool</span>
<span class="sd">        Whether or not the optimizer exited successfully.</span>
<span class="sd">    cost : float</span>
<span class="sd">        Value of the cost function at the solution.</span>
<span class="sd">    residuals : ndarray</span>
<span class="sd">        Vector of residuals at the solution.</span>

<span class="sd">    Other parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    weights : array_like </span>
<span class="sd">        Array of weighting coefficients for the individual signals in global fitting, the default is all weighted equally.</span>
<span class="sd">    rescale : boolean</span>
<span class="sd">        Enable/disable optimization of the signal scale, by default it is enabled.</span>
<span class="sd">    multiStarts : scalar</span>
<span class="sd">        Number of starting points for global optimization, the default is 1.</span>
<span class="sd">    uqanalysis : boolean</span>
<span class="sd">        Enable/disable the uncertainty quantification analysis, by default it is enabled.    </span>
<span class="sd">    tol : scalar</span>
<span class="sd">        Optimizer function tolerance, the default is 1e-10.</span>
<span class="sd">    maxeval : scalar</span>
<span class="sd">        Maximum number of optimizer iterations, the default is 5000.</span>
<span class="sd">    maxiter : scalar</span>
<span class="sd">        Maximum number of optimizer iterations, the default is 3000.</span>
<span class="sd">    covmatrix : array_like with shape(n,n)</span>
<span class="sd">        Covariance matrix of the noise in the dataset(s). If not specified it is automatically computed.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    A simple example for fitting a fully parametric 4-pulse DEER signal::</span>

<span class="sd">        K0 = dl.dipolarkernel(t,r)</span>
<span class="sd">        def Vmodel(par):</span>
<span class="sd">            # Extract parameters</span>
<span class="sd">            rmean,fwhm,lam,conc = par</span>
<span class="sd">            B = dl.bg_hom3d(t,conc)</span>
<span class="sd">            P = dl.dd_gauss(r,[rmean,fwhm])</span>
<span class="sd">            V = (1-lam + lam*K0@P)*B</span>
<span class="sd">            return V</span>
<span class="sd">        </span>
<span class="sd">        # par: rmean fwhm lam conc</span>
<span class="sd">        par0 = [3.5, 0.5, 0.2, 250] # start values</span>
<span class="sd">        lb   = [ 1,  0.1,  0,  50 ] # lower bounds</span>
<span class="sd">        ub   = [20,   5,   1,  800] # upper bounds</span>
<span class="sd">        fit = dl.fitparamodel(V,Vmodel,par0,lb,ub)</span>


<span class="sd">    If multiple datasets are to be fitted globally, this can be easily achieved by adapting the example above. Differentiating between local and global parameters is also simple. This example shows the definition of a full parametric model of two signals with same underlying distance distribution and background but different modulation depths::</span>
<span class="sd">    </span>
<span class="sd">        K1 = dl.dipolarkernel(t1,r)</span>
<span class="sd">        K1 = dl.dipolarkernel(t2,r)</span>
<span class="sd">        def Vmodel(par):</span>
<span class="sd">            # Extract parameters</span>
<span class="sd">            rmean,fwhm,lam1,lam,2conc = par</span>
<span class="sd">            B = dl.bg_hom3d(t,conc)</span>
<span class="sd">            P = dl.dd_gauss(r,[rmean,fwhm])</span>
<span class="sd">            V1 = (1-lam1 + lam1*K1@P)*B</span>
<span class="sd">            V2 = (1-lam2 + lam2*K2@P)*B</span>
<span class="sd">            return V</span>
<span class="sd">        </span>
<span class="sd">        # par: rmean fwhm lam1 lam2 conc</span>
<span class="sd">        par0 = [3.5, 0.5, 0.2, 0.3, 250] # start values</span>
<span class="sd">        lb   = [ 1,  0.1,  0,   0,  50 ] # lower bounds</span>
<span class="sd">        ub   = [20,   5,   1,   1,  800] # upper bounds</span>
<span class="sd">        fit = dl.fitparamodel([V1,V2],Vmodel,par0,lb,ub)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">isempty</span><span class="p">(</span><span class="n">par0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;The start values par0 of the parameters must be specified&#39;</span><span class="p">)</span>

    <span class="n">lb</span><span class="p">,</span><span class="n">ub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="nf">atleast_1d</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span><span class="n">ub</span><span class="p">)</span>
    <span class="n">V</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">Vsubsets</span> <span class="o">=</span> <span class="n">parse_multidatasets</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
    <span class="n">Nsignals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Vsubsets</span><span class="p">)</span>
    <span class="n">scales</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">Nsignals</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="nf">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="nf">isreal</span><span class="p">(</span><span class="n">V</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The input signal(s) cannot be complex-valued.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">isempty</span><span class="p">(</span><span class="n">lb</span><span class="p">):</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="nf">full_like</span><span class="p">(</span><span class="n">par0</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">isempty</span><span class="p">(</span><span class="n">ub</span><span class="p">):</span>
        <span class="n">ub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="nf">full_like</span><span class="p">(</span><span class="n">par0</span><span class="p">,</span> <span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>

    <span class="c1"># Prepare upper/lower bounds on parameter search range</span>
    <span class="n">unboundedparams</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="nf">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">lb</span><span class="p">))</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="nf">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">ub</span><span class="p">))</span>

    <span class="k">if</span>  <span class="nb">len</span><span class="p">(</span><span class="n">par0</span><span class="p">)</span><span class="o">!=</span><span class="nb">len</span><span class="p">(</span><span class="n">ub</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">par0</span><span class="p">)</span><span class="o">!=</span><span class="nb">len</span><span class="p">(</span><span class="n">lb</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The inital guess and upper/lower boundaries must have equal length.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="nf">any</span><span class="p">(</span><span class="n">ub</span><span class="o">&lt;</span><span class="n">lb</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Lower bound values cannot be larger than upper bound values.&#39;</span><span class="p">)</span>

    <span class="c1"># Preprare multiple start global optimization if requested</span>
    <span class="k">if</span> <span class="n">multistart</span><span class="o">&gt;</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">unboundedparams</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;multistart optimization cannot be used with unconstrained parameters.&#39;</span><span class="p">)</span>
    <span class="n">multistarts_par0</span> <span class="o">=</span> <span class="n">multistarts</span><span class="p">(</span><span class="n">multistart</span><span class="p">,</span><span class="n">par0</span><span class="p">,</span><span class="n">lb</span><span class="p">,</span><span class="n">ub</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">lsqresiduals</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="c1"># -------------------------------------------------------------------------------    </span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Residual vector function</span>
<span class="sd">        ------------------------------------------------------------------</span>
<span class="sd">        Function that provides vector of residuals, which is the objective</span>
<span class="sd">        function for the least-squares solvers</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">scales</span>

        <span class="n">Vsim</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c1"># Check if there are invalid values...</span>
        <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Vsim</span><span class="p">))</span> <span class="ow">or</span> <span class="nf">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">Vsim</span><span class="p">)):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="nf">zeros_like</span><span class="p">(</span><span class="n">Vsim</span><span class="p">)</span> <span class="c1"># ...can happen when Jacobian is evaluated outside of bounds</span>
            <span class="k">return</span> <span class="n">res</span>

        <span class="c1"># Otherwise if requested, compute the scale of the signal via linear LSQ   </span>
        <span class="k">if</span> <span class="n">rescale</span><span class="p">:</span>
            <span class="n">scales</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">Vsubsets</span><span class="p">:</span>
                <span class="n">Vsim_</span><span class="p">,</span><span class="n">V_</span> <span class="o">=</span> <span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span> <span class="k">for</span> <span class="n">V</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Vsim</span><span class="p">,</span> <span class="n">V</span><span class="p">])</span> <span class="c1"># Rescale the subsets corresponding to each signal</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="nf">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="nf">atleast_2d</span><span class="p">(</span><span class="n">Vsim_</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="nf">atleast_2d</span><span class="p">(</span><span class="n">V_</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">Vsim</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="o">*</span><span class="n">Vsim_</span>  
                <span class="n">scales</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span> <span class="c1"># Store the optimized scales of each signal</span>

        <span class="c1"># Compute the residual</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">weights</span><span class="o">*</span><span class="p">(</span><span class="n">V</span><span class="o">-</span><span class="n">Vsim</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">res</span>
    <span class="c1"># -------------------------------------------------------------------------------    </span>
    <span class="n">fvals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">parfits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">par0</span> <span class="ow">in</span> <span class="n">multistarts_par0</span><span class="p">:</span>
        <span class="c1"># Solve the non-linear least squares (NLLS) problem </span>
        <span class="n">sol</span> <span class="o">=</span> <span class="n">least_squares</span><span class="p">(</span><span class="n">lsqresiduals</span> <span class="p">,</span><span class="n">par0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span><span class="n">ub</span><span class="p">),</span> <span class="n">max_nfev</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">maxiter</span><span class="p">),</span> <span class="n">ftol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;dogbox&#39;</span><span class="p">)</span>
        <span class="n">sols</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">sol</span><span class="p">)</span>
        <span class="n">parfits</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="n">fvals</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">cost</span><span class="p">)</span>        

    <span class="c1"># Find global minimum from multiple runs</span>
    <span class="n">globmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="nf">argmin</span><span class="p">(</span><span class="n">fvals</span><span class="p">)</span>
    <span class="n">parfit</span> <span class="o">=</span> <span class="n">parfits</span><span class="p">[</span><span class="n">globmin</span><span class="p">]</span>
    <span class="n">sol</span> <span class="o">=</span> <span class="n">sols</span><span class="p">[</span><span class="n">globmin</span><span class="p">]</span>
    <span class="c1"># Issue warnings if fitted parameter values are at search range boundaries</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-5</span>
    <span class="n">atLower</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">parfit</span><span class="o">-</span><span class="n">lb</span><span class="p">)</span><span class="o">&lt;</span><span class="n">tol</span>
    <span class="n">atUpper</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">parfit</span><span class="o">-</span><span class="n">ub</span><span class="p">)</span><span class="o">&lt;</span><span class="n">tol</span>
    <span class="n">fixedPar</span> <span class="o">=</span> <span class="n">lb</span><span class="o">==</span><span class="n">ub</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parfit</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">fixedPar</span><span class="p">[</span><span class="n">p</span><span class="p">]:</span>
            <span class="c1"># Skip if parameter is fixed</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">atLower</span><span class="p">[</span><span class="n">p</span><span class="p">]:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;The fitted value of parameter #</span><span class="si">{}</span><span class="s1">, is at the lower bound (</span><span class="si">{}</span><span class="s1">).&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">lb</span><span class="p">[</span><span class="n">p</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">atUpper</span><span class="p">[</span><span class="n">p</span><span class="p">]:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;The fitted value of parameter #</span><span class="si">{}</span><span class="s1">,  is at the upper bound (</span><span class="si">{}</span><span class="s1">).&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">ub</span><span class="p">[</span><span class="n">p</span><span class="p">]))</span>

    <span class="c1"># Calculate parameter confidence intervals</span>
    <span class="k">if</span> <span class="n">uqanalysis</span><span class="p">:</span>
        
        <span class="c1"># Compute residual vector and estimate variance from that</span>
        <span class="n">residuals</span> <span class="o">=</span> <span class="n">lsqresiduals</span><span class="p">(</span><span class="n">parfit</span><span class="p">)</span>
        
        <span class="c1"># Calculate numerical estimates of the Jacobian and Hessian</span>
        <span class="c1"># of the negative log-likelihood</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
            <span class="n">J</span> <span class="o">=</span> <span class="n">Jacobian</span><span class="p">(</span><span class="n">lsqresiduals</span><span class="p">,</span><span class="n">parfit</span><span class="p">,</span><span class="n">lb</span><span class="p">,</span><span class="n">ub</span><span class="p">)</span>

        <span class="c1"># Estimate the heteroscedasticity-consistent covariance matrix</span>
        <span class="k">if</span> <span class="n">isempty</span><span class="p">(</span><span class="n">covmatrix</span><span class="p">):</span>
            <span class="c1"># Use estimated data covariance matrix</span>
            <span class="n">covmatrix</span> <span class="o">=</span> <span class="n">hccm</span><span class="p">(</span><span class="n">J</span><span class="p">,</span><span class="n">residuals</span><span class="p">,</span><span class="s1">&#39;HC1&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use user-given data covariance matrix</span>
            <span class="n">covmatrix</span> <span class="o">=</span> <span class="n">hccm</span><span class="p">(</span><span class="n">J</span><span class="p">,</span><span class="n">covmatrix</span><span class="p">)</span>
        <span class="c1"># Construct confidence interval structure</span>
        <span class="n">paruq</span> <span class="o">=</span> <span class="n">UncertQuant</span><span class="p">(</span><span class="s1">&#39;covariance&#39;</span><span class="p">,</span><span class="n">parfit</span><span class="p">,</span><span class="n">covmatrix</span><span class="p">,</span><span class="n">lb</span><span class="p">,</span><span class="n">ub</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">paruq</span> <span class="o">=</span> <span class="n">UncertQuant</span><span class="p">(</span><span class="s1">&#39;void&#39;</span><span class="p">)</span>

    <span class="c1"># Calculate goodness of fit</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Vfit</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">parfit</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">Vsubsets</span><span class="p">:</span> 
        <span class="n">Ndof</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">subset</span><span class="p">])</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">par0</span><span class="p">)</span>
        <span class="n">stats</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">goodness_of_fit</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">subset</span><span class="p">],</span><span class="n">Vfit</span><span class="p">[</span><span class="n">subset</span><span class="p">],</span><span class="n">Ndof</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">Nsignals</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> 
        <span class="n">stats</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">scales</span> <span class="o">=</span> <span class="n">scales</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Get plot function</span>
    <span class="n">plotfcn</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">_plot</span><span class="p">(</span><span class="n">Vsubsets</span><span class="p">,</span><span class="n">V</span><span class="p">,</span><span class="n">Vfit</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">FitResult</span><span class="p">(</span>
            <span class="n">param</span><span class="o">=</span><span class="n">parfit</span><span class="p">,</span> <span class="n">uncertainty</span><span class="o">=</span><span class="n">paruq</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scales</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="n">stats</span><span class="p">,</span> <span class="n">cost</span><span class="o">=</span><span class="n">fvals</span><span class="p">,</span>
            <span class="nf">plot</span><span class="o">=</span><span class="n">plotfcn</span><span class="p">,</span> <span class="n">residuals</span><span class="o">=</span><span class="n">sol</span><span class="o">.</span><span class="n">fun</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="n">sol</span><span class="o">.</span><span class="n">success</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">_plot</span><span class="p">(</span><span class="n">Vsubsets</span><span class="p">,</span><span class="n">V</span><span class="p">,</span><span class="n">Vfit</span><span class="p">):</span>
    <span class="n">nSignals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Vsubsets</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span><span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="nf">subplots</span><span class="p">(</span><span class="n">nSignals</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">nSignals</span><span class="p">])</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="nf">atleast_1d</span><span class="p">(</span><span class="n">axs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nSignals</span><span class="p">):</span> 
        <span class="n">subset</span> <span class="o">=</span> <span class="n">Vsubsets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># Plot the experimental signal and fit</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">subset</span><span class="p">],</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">Vfit</span><span class="p">[</span><span class="n">subset</span><span class="p">],</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="nf">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Array Elements&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;V[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="nf">legend</span><span class="p">((</span><span class="s1">&#39;Data&#39;</span><span class="p">,</span><span class="s1">&#39;Fit&#39;</span><span class="p">))</span>

    <span class="n">plt</span><span class="o">.</span><span class="nf">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="nf">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">axs</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2019-2020, Luis Fábregas Ibáñez, Stefan Stoll, and others

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(false);
      });
  </script>

  
  
    
   

</body>
</html>